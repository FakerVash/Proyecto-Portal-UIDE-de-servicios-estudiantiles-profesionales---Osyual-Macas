generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Rol {
  ESTUDIANTE
  CLIENTE
  ADMIN
}

enum EstadoPedido {
  pendiente
  en_proceso
  completado
  cancelado
}

model Usuario {
  id              Int       @id @default(autoincrement()) @map("id_usuario")
  email           String    @unique @db.VarChar(100)
  contrasena      String    @db.VarChar(255)
  nombre          String    @db.VarChar(100)
  apellido        String    @db.VarChar(100)
  telefono        String?   @db.VarChar(20)
  rol             Rol       @default(CLIENTE)
  fotoPerfil      String?   @map("foto_perfil") @db.VarChar(255)
  calificacionPromedio Decimal @default(0.00) @map("calificacion_promedio") @db.Decimal(3, 2)
  universidad     String?   @default("Universidad Internacional") @db.VarChar(150)
  fechaRegistro   DateTime  @default(now()) @map("fecha_registro")
  activo          Boolean   @default(true)
  
  carreraId       Int?      @map("id_carrera")
  carrera         Carrera?  @relation(fields: [carreraId], references: [id])
  
  servicios       Servicio[]
  pedidos         Pedido[]   @relation("ClientePedido")
  habilidades     UsuarioHabilidad[]
  carritos        Carrito[]
  favoritos       Favorito[]
  notificaciones  Notificacion[]
  
  // Chat
  conversacionesIniciadas Conversacion[] @relation("Participante1")
  conversacionesRecibidas Conversacion[] @relation("Participante2")
  mensajesEnviados        Mensaje[]

  @@map("usuarios")
}

model Facultad {
  id      Int       @id @default(autoincrement()) @map("id_facultad")
  nombre  String    @unique @map("nombre_facultad") @db.VarChar(150)
  
  carreras Carrera[]

  @@map("facultades")
}

model Carrera {
  id         Int      @id @default(autoincrement()) @map("id_carrera")
  facultadId Int      @map("id_facultad")
  nombre     String   @map("nombre_carrera") @db.VarChar(150)
  
  facultad   Facultad @relation(fields: [facultadId], references: [id], onDelete: Cascade)
  usuarios   Usuario[]

  @@map("carreras")
}

model Categoria {
  id          Int      @id @default(autoincrement()) @map("id_categoria")
  nombre      String   @unique @map("nombre_categoria") @db.VarChar(100)
  descripcion String?  @db.Text
  icono       String?  @db.VarChar(50)
  
  servicios   Servicio[]

  @@map("categorias")
}

model Servicio {
  id               Int      @id @default(autoincrement()) @map("id_servicio")
  usuarioId        Int      @map("id_usuario")
  categoriaId      Int      @map("id_categoria")
  titulo           String   @db.VarChar(200)
  descripcion      String   @db.Text
  precio           Decimal  @db.Decimal(10, 2)
  precioHora       Boolean  @default(false) @map("precio_hora")
  tiempoEntrega    String?  @map("tiempo_entrega") @db.VarChar(100)
  imagenPortada    String?  @map("imagen_portada") @db.VarChar(255)
  
  contactoWhatsapp String?  @map("contacto_whatsapp") @db.VarChar(20)
  contactoEmail    String?  @map("contacto_email") @db.VarChar(100)
  contactoTelefono String?  @map("contacto_telefono") @db.VarChar(20)
  
  fechaPublicacion DateTime @default(now()) @map("fecha_publicacion")
  activo           Boolean  @default(true)
  
  proveedor        Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  categoria        Categoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  
  pedidos          Pedido[]
  resenas          Resena[]
  carritos         Carrito[]
  favoritos        Favorito[]

  @@map("servicios")
}

model Habilidad {
  id      Int       @id @default(autoincrement()) @map("id_habilidad")
  nombre  String    @unique @map("nombre_habilidad") @db.VarChar(100)
  
  usuarios UsuarioHabilidad[]

  @@map("habilidades")
}

model UsuarioHabilidad {
  id          Int       @id @default(autoincrement())
  usuarioId   Int       @map("id_usuario")
  habilidadId Int       @map("id_habilidad")
  
  usuario     Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  habilidad   Habilidad @relation(fields: [habilidadId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, habilidadId])
  @@map("usuario_habilidades")
}

model Carrito {
  id        Int      @id @default(autoincrement()) @map("id_carrito")
  clienteId Int      @map("id_cliente")
  servicioId Int     @map("id_servicio")
  horas     Int      @default(1)
  fechaAgregado DateTime @default(now()) @map("fecha_agregado")

  cliente   Usuario  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  servicio  Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@map("carritos")
}

model Pedido {
  id                 Int          @id @default(autoincrement()) @map("id_pedido")
  servicioId         Int          @map("id_servicio")
  clienteId          Int          @map("id_cliente")
  estado             EstadoPedido @default(pendiente)
  subtotal           Decimal      @db.Decimal(10, 2)
  comisionPlataforma Decimal      @map("comision_plataforma") @db.Decimal(10, 2)
  montoTotal         Decimal      @map("monto_total") @db.Decimal(10, 2)
  fechaPedido        DateTime     @default(now()) @map("fecha_pedido")
  fechaEntrega       DateTime?    @map("fecha_entrega")
  notas              String?      @db.Text
  
  servicio           Servicio     @relation(fields: [servicioId], references: [id])
  cliente            Usuario      @relation("ClientePedido", fields: [clienteId], references: [id])
  resena             Resena?

  @@map("pedidos")
}

model Resena {
  id           Int      @id @default(autoincrement()) @map("id_resena")
  pedidoId     Int      @unique @map("id_pedido")
  servicioId   Int      @map("id_servicio")
  calificacion Int
  comentario   String?  @db.Text
  fechaResena  DateTime @default(now()) @map("fecha_resena")
  
  pedido       Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  servicio     Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@map("resenas")
}

model Favorito {
  usuarioId  Int @map("id_usuario")
  servicioId Int @map("id_servicio")

  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  servicio   Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@id([usuarioId, servicioId])
  @@map("favoritos")
}

model Conversacion {
  id                  Int       @id @default(autoincrement()) @map("id_conversacion")
  participante1Id     Int       @map("participante_1_id")
  participante2Id     Int       @map("participante_2_id")
  fechaCreacion       DateTime  @default(now()) @map("fecha_creacion")
  ultimaActualizacion DateTime  @default(now()) @updatedAt @map("ultima_actualizacion")

  participante1       Usuario   @relation("Participante1", fields: [participante1Id], references: [id])
  participante2       Usuario   @relation("Participante2", fields: [participante2Id], references: [id])
  mensajes            Mensaje[]

  @@unique([participante1Id, participante2Id])
  @@map("conversaciones")
}

model Mensaje {
  id             Int      @id @default(autoincrement()) @map("id_mensaje")
  conversacionId Int      @map("id_conversacion")
  emisorId       Int      @map("id_emisor")
  contenido      String   @db.Text
  leido          Boolean  @default(false)
  fechaEnvio     DateTime @default(now()) @map("fecha_envio")

  conversacion   Conversacion @relation(fields: [conversacionId], references: [id], onDelete: Cascade)
  emisor         Usuario      @relation(fields: [emisorId], references: [id])

  @@map("mensajes")
}

enum TipoNotificacion {
  pedido
  mensaje
  sistema
}

model Notificacion {
  id                Int      @id @default(autoincrement()) @map("id_notificacion")
  usuarioId         Int      @map("id_usuario")
  titulo            String   @db.VarChar(100)
  mensaje           String   @db.Text
  leido             Boolean  @default(false)
  tipo              TipoNotificacion @default(sistema)
  fechaNotificacion DateTime @default(now()) @map("fecha_notificacion")

  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}
