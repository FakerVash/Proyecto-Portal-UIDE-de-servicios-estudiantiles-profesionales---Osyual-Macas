generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. MODELO DE ROLES
model Role {
  id          Int       @id @default(autoincrement())
  nombre      String    @unique // 'admin', 'cliente', 'estudiante'
  descripcion String?   @db.Text
  permisos    Json?     // Para flexibilidad adicional
  usuarios    Usuario[]

  @@map("roles")
}

// 2. MODELO DE USUARIOS
model Usuario {
  id                          Int       @id @default(autoincrement())
  nombreCompleto              String    @map("nombre_completo") @db.VarChar(150)
  email                       String    @unique @db.VarChar(100)
  passwordHash                String    @map("password_hash") @db.VarChar(255)
  telefono                    String?   @db.VarChar(20)
  avatarUrl                   String?   @map("avatar_url") @db.VarChar(255)
  rolId                       Int       @map("rol_id")
  universidad                 String?   @db.VarChar(150)
  carrera                     String?   @db.VarChar(100)
  semestre                    Int?
  biografia                   String?   @db.Text
  calificacionPromedio        Decimal   @default(0.00) @map("calificacion_promedio") @db.Decimal(3, 2)
  totalServiciosContratados   Int       @default(0) @map("total_servicios_contratados")
  totalServiciosPublicados    Int       @default(0) @map("total_servicios_publicados")
  estado                      EstadoUsuario @default(activo)
  ultimaConexion              DateTime? @map("ultima_conexion")
  fechaRegistro               DateTime  @default(now()) @map("fecha_registro")

  // Relaciones
  role                        Role      @relation(fields: [rolId], references: [id])
  servicios                   Servicio[] @relation("EstudianteServicios")
  serviciosEliminados         Servicio[] @relation("AdminEliminador")
  transaccionesComoCliente    Transaccion[] @relation("ClienteTransacciones")
  transaccionesComoEstudiante Transaccion[] @relation("EstudianteTransacciones")
  resenasEscritas             Resena[]  @relation("ClienteResenas")
  resenasRecibidas            Resena[]  @relation("EstudianteResenas")
  resenasModeradas            Resena[]  @relation("ModeradorResenas")
  conversacionesComoCliente   Conversacion[] @relation("ClienteConversaciones")
  conversacionesComoEstudiante Conversacion[] @relation("EstudianteConversaciones")
  mensajesEnviados            MensajeChat[]
  reportesRealizados          Reporte[] @relation("Reportador")
  reportesRevisados           Reporte[] @relation("Revisador")

  @@index([email], name: "idx_usuarios_email")
  @@index([rolId], name: "idx_usuarios_rol")
  @@map("usuarios")
}

enum EstadoUsuario {
  activo
  inactivo
  suspendido
}

// 3. MODELO DE CATEGORÍAS
model Categoria {
  id          Int        @id @default(autoincrement())
  nombre      String     @unique @db.VarChar(100)
  icono       String?    @db.VarChar(50)
  descripcion String?    @db.Text
  activa      Boolean    @default(true)
  servicios   Servicio[]

  @@map("categorias")
}

// 4. MODELO DE SERVICIOS
model Servicio {
  id                  Int       @id @default(autoincrement())
  estudianteId        Int       @map("estudiante_id")
  titulo              String    @db.VarChar(150)
  descripcion         String    @db.Text
  categoriaId         Int       @map("categoria_id")
  precioHora          Decimal   @map("precio_hora") @db.Decimal(10, 2)
  imageUrl            String?   @map("imagen_url") @db.VarChar(255)
  duracionMinima      Int       @default(1) @map("duracion_minima")
  disponibilidad      Json?
  estado              EstadoServicio @default(activo)
  calificacionPromedio Decimal   @default(0.00) @map("calificacion_promedio") @db.Decimal(3, 2)
  totalVentas         Int       @default(0) @map("total_ventas")
  totalVisualizaciones Int       @default(0) @map("total_visualizaciones")
  eliminadoPorAdmin   Int?      @map("eliminado_por_admin")
  razonEliminacion    String?   @map("razon_eliminacion") @db.Text
  fechaCreacion       DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime  @default(now()) @updatedAt @map("fecha_actualizacion")

  // Relaciones
  estudiante          Usuario   @relation("EstudianteServicios", fields: [estudianteId], references: [id])
  categoria           Categoria @relation(fields: [categoriaId], references: [id])
  adminEliminador     Usuario?  @relation("AdminEliminador", fields: [eliminadoPorAdmin], references: [id])
  transacciones       Transaccion[]
  resenas             Resena[]
  conversaciones      Conversacion[]

  @@index([estado], name: "idx_servicios_estado")
  @@map("servicios")
}

enum EstadoServicio {
  activo
  pausado
  inactivo
  eliminado
}

// 5. MODELO DE TRANSACCIONES
model Transaccion {
  id                  Int       @id @default(autoincrement())
  clienteId           Int       @map("cliente_id")
  estudianteId        Int       @map("estudiante_id")
  servicioId          Int       @map("servicio_id")
  montoTotal          Decimal   @map("monto_total") @db.Decimal(10, 2)
  horasContratadas    Int       @map("horas_contratadas")
  estado              EstadoTransaccion @default(pendiente)
  fechaInicioServicio DateTime? @map("fecha_inicio_servicio")
  fechaFinServicio    DateTime? @map("fecha_fin_servicio")
  metodoPago          String?   @map("metodo_pago") @db.VarChar(50)
  notasCliente        String?   @map("notas_cliente") @db.Text
  notasEstudiante     String?   @map("notas_estudiante") @db.Text
  fechaTransaccion    DateTime  @default(now()) @map("fecha_transaccion")

  // Relaciones
  cliente             Usuario   @relation("ClienteTransacciones", fields: [clienteId], references: [id])
  estudiante          Usuario   @relation("EstudianteTransacciones", fields: [estudianteId], references: [id])
  servicio            Servicio  @relation(fields: [servicioId], references: [id])
  resenas             Resena[]
  pagos               Pago[]

  @@index([estado], name: "idx_transacciones_estado")
  @@map("transacciones")
}

enum EstadoTransaccion {
  pendiente
  aceptado
  en_progreso
  completado
  cancelado
}

// 6. MODELO DE RESEÑAS
model Resena {
  id                  Int       @id @default(autoincrement())
  transaccionId       Int       @map("transaccion_id")
  clienteId           Int       @map("cliente_id")
  estudianteId        Int       @map("estudiante_id")
  servicioId          Int       @map("servicio_id")
  calificacion        Int       
  comentario          String?   @db.Text
  respuestaEstudiante String?   @map("respuesta_estudiante") @db.Text
  fechaCreacion       DateTime  @default(now()) @map("fecha_creacion")
  fechaRespuesta      DateTime? @map("fecha_respuesta")
  moderadaPor         Int?      @map("moderada_por")
  visible             Boolean   @default(true)

  // Relaciones
  transaccion         Transaccion @relation(fields: [transaccionId], references: [id])
  cliente             Usuario     @relation("ClienteResenas", fields: [clienteId], references: [id])
  estudiante          Usuario     @relation("EstudianteResenas", fields: [estudianteId], references: [id])
  servicio            Servicio    @relation(fields: [servicioId], references: [id])
  moderador           Usuario?    @relation("ModeradorResenas", fields: [moderadaPor], references: [id])

  @@map("resenas")
}

// 7. MODELO DE MENSAJERÍA
model Conversacion {
  id                  Int       @id @default(autoincrement())
  clienteId           Int       @map("cliente_id")
  estudianteId        Int       @map("estudiante_id")
  servicioId          Int?      @map("servicio_id")
  ultimoMensaje       String?   @map("ultimo_mensaje") @db.Text
  fechaUltimoMensaje  DateTime  @default(now()) @map("fecha_ultimo_mensaje")
  activa              Boolean   @default(true)

  // Relaciones
  cliente             Usuario   @relation("ClienteConversaciones", fields: [clienteId], references: [id])
  estudiante          Usuario   @relation("EstudianteConversaciones", fields: [estudianteId], references: [id])
  servicio            Servicio? @relation(fields: [servicioId], references: [id])
  mensajes            MensajeChat[]

  @@map("conversaciones")
}

model MensajeChat {
  id              Int       @id @default(autoincrement())
  conversacionId  Int       @map("conversacion_id")
  emisorId        Int       @map("emisor_id")
  mensaje         String    @db.Text
  archivoUrl      String?   @map("archivo_url") @db.VarChar(255)
  leido           Boolean   @default(false)
  fechaEnvio      DateTime  @default(now()) @map("fecha_envio")
  eliminado       Boolean   @default(false)

  // Relaciones
  conversacion    Conversacion @relation(fields: [conversacionId], references: [id])
  emisor          Usuario      @relation(fields: [emisorId], references: [id])

  @@index([conversacionId], name: "idx_mensajes_conversacion")
  @@map("mensajes_chat")
}

// 8. MODELO DE PAGOS
model Pago {
  id                  Int       @id @default(autoincrement())
  transaccionId       Int       @map("transaccion_id")
  metodoPago          String?   @map("metodo_pago") @db.VarChar(50)
  referenciaPago      String?   @map("referencia_pago") @db.VarChar(100)
  monto               Decimal   @db.Decimal(10, 2)
  comisionPlataforma  Decimal?  @map("comision_plataforma") @db.Decimal(10, 2)
  montoEstudiante     Decimal?  @map("monto_estudiante") @db.Decimal(10, 2)
  estado              EstadoPago @default(pendiente)
  fechaPago           DateTime  @default(now()) @map("fecha_pago")
  fechaLiberacion     DateTime? @map("fecha_liberacion")

  // Relaciones
  transaccion         Transaccion @relation(fields: [transaccionId], references: [id])

  @@map("pagos")
}

enum EstadoPago {
  exitoso
  fallido
  pendiente
  reembolsado
}

// 9. MODELO DE REPORTES
model Reporte {
  id                  Int       @id @default(autoincrement())
  reportadorId        Int       @map("reportador_id")
  tipo                TipoReporte
  elementoReportadoId Int       @map("elemento_reportado_id")
  categoriaReporte    CategoriaReporte @map("categoria_reporte")
  descripcion         String?   @db.Text
  estado              EstadoReporte @default(pendiente)
  revisadoPor         Int?      @map("revisado_por")
  notasAdmin          String?   @map("notas_admin") @db.Text
  fechaReporte        DateTime  @default(now()) @map("fecha_reporte")
  fechaRevision       DateTime? @map("fecha_revision")

  // Relaciones
  reportador          Usuario   @relation("Reportador", fields: [reportadorId], references: [id])
  revisador           Usuario?  @relation("Revisador", fields: [revisadoPor], references: [id])

  @@map("reportes")
}

enum TipoReporte {
  servicio
  usuario
  resena
}

enum CategoriaReporte {
  spam
  inapropiado
  fraude
  otro
}

enum EstadoReporte {
  pendiente
  revisado
  resuelto
  rechazado
}